<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>BÃ¡nh Trung Thu</title>
</head>

<body>
  <div class="flipbook-container">
    <div class="flipbook">
      <div class="">
        <img src="image/1.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/2.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/3.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/4.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/5.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/6.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/7.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/8.webp" alt="" />
      </div>
      <div class="page">
          <img src="image/9.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/10.webp" alt="" />
      </div>
        <div class="page">
        <img src="image/11.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/12.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/13.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/14.webp" alt="" />
      </div>
      <div class="page">
        <img src="image/15.webp" alt="" />
      </div>
      <div class="">
        <img src="image/16.webp" alt="" />
      </div>
    </div>
  </div>

  <audio id="bgMusic" loop autoplay>
    <source src="./image/music.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <audio id="flipSound">
    <source src="./image/page-flip.mp3" type="audio/mpeg">
  </audio>

  <script src="jquery.js"></script>
  <script src="turn.js"></script>
  <script>
    // Function to check if device is mobile
    function isMobile() {
      return window.innerWidth < 1024;
    }

    // Calculate dimensions based on viewport and aspect ratio
    function calculateDimensions() {
      const aspectRatio = 9/13.5;
      let width, height;
      
      if (isMobile()) {
        // Single page view
        width = Math.min(window.innerWidth * 0.95, window.innerHeight * aspectRatio * 0.95);
        height = width / aspectRatio;
      } else {
        // Double page view
        width = Math.min(window.innerWidth * 0.95, window.innerHeight * aspectRatio * 0.95 * 2);
        height = width / (aspectRatio * 2);
      }
      
      return {
        width: width,
        height: height
      };
    }

    // Function to play page flip sound
    function playFlipSound() {
      const flipSound = document.getElementById('flipSound');
      flipSound.currentTime = 0; // Reset sound to start
      flipSound.volume = 0.5; // Set appropriate volume
      flipSound.play();
    }

    // Function to get relative position within an element
    function getRelativePosition(e, element) {
      const rect = element.getBoundingClientRect();
      const event = e.type.includes('touch') ? e.touches[0] : e;
      const x = (event.clientX - rect.left) / rect.width;
      const y = (event.clientY - rect.top) / rect.height;
      return { x, y };
    }

    // Function to determine corner based on position
    function getCornerFromPosition(pos) {
      const { x, y } = pos;
      
      // For middle area, use the closest vertical edge
      if (x < 0.4) return 'bl,tl';
      if (x > 0.6) return 'br,tr';
      
      // For middle drag, use the side the drag started from
      return x < 0.5 ? 'bl,tl' : 'br,tr';
    }

    // Variables for drag tracking
    let isDragging = false;
    let startPos = null;
    let currentCorner = null;
    let lastPeelValue = 0;

    // Initialize flipbook with appropriate display mode and dimensions
    function initFlipbook() {
      const dimensions = calculateDimensions();
      
      $(".flipbook").turn({
        display: isMobile() ? 'single' : 'double',
        width: dimensions.width,
        height: dimensions.height,
        autoCenter: true,
        acceleration: true,
        elevation: 50,
        gradients: true,
        duration: 1500,
        when: {
          turning: function(event, page, view) {
            if (Math.abs(lastPeelValue - 0.5) > 0.1) {
              playFlipSound();
            }
          },
        }
      });
    }

    // Prevent default scroll behavior
    document.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('wheel', function(e) {
      e.preventDefault();
    }, { passive: false });

    // Initialize the flipbook
    $(document).ready(function() {
      initFlipbook();
      
      // Handle scroll events for page navigation with debounce
      let scrollTimeout;
      let isScrolling = false;
      
      // Touch swipe variables
      let touchStartX = 0;
      let touchEndX = 0;
      const minSwipeDistance = 50; // Minimum distance for a swipe
      
      // Touch start event
      $('.flipbook').on('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
      });
      
      // Touch end event
      $('.flipbook').on('touchend', function(e) {
        touchEndX = e.changedTouches[0].clientX;
        handleSwipe();
      });
      
      // Handle swipe
      function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        
        // Check if swipe distance is significant enough
        if (Math.abs(swipeDistance) > minSwipeDistance) {
          if (swipeDistance > 0) {
            // Swipe right - previous page
            $(".flipbook").turn("previous");
          } else {
            // Swipe left - next page
            $(".flipbook").turn("next");
          }
        }
      }
      
      $(window).on('wheel', function(event) {
        if (isScrolling) return;
        
        isScrolling = true;
        
        if (event.originalEvent.deltaY > 0) {
          // Scrolling down - next page
          $(".flipbook").turn("next");
        } else {
          // Scrolling up - previous page
          $(".flipbook").turn("previous");
        }
        
        // Reset scroll flag after animation completes
        setTimeout(function() {
          isScrolling = false;
        }, 500);
      });

      // Handle background music autoplay
      const bgMusic = document.getElementById('bgMusic');
      
      // Try to play the music automatically
      const playPromise = bgMusic.play();
      
      // Add event listener for the play button
      $(".flipbook").on('click', function() {
        if (playPromise !== undefined) {
          bgMusic.play();
        }
      });
    });

    // Handle window resize to update dimensions and display mode
    $(window).on('resize', function() {
      const dimensions = calculateDimensions();
      
      $(".flipbook").turn("size", dimensions.width, dimensions.height);
      $(".flipbook").turn("display", isMobile() ? 'single' : 'double');
    });
  </script>
</body>

</html>